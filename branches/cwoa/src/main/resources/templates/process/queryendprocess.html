 <!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8" />
		<title>结束流程查询</title>
		<meta name="renderer" content="webkit" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link rel="stylesheet" href="../../static/css/reset.css" />
		<link rel="stylesheet" href="./../../static/layui/css/layui.css" />
	</head>

	<body layadmin-themealias="default">
		<h2>查询中ing...</h2>
		<div class="layui-fluid" style="margin-top: 10px;" id="queryProcessBox">
			<!-- 数据显示区域 -->
		</div>
		<center>
			<div id="demo6"></div>
		</center>
		<div class="layadmin-body-shade" layadmin-event="shade"></div>
		<script src="./../../static/layui/layui.js"></script>
		<script>
			//<![CDATA[
			Date.prototype.format = function(fmt) {
				var o = {
					"M+": this.getMonth() + 1, //月份 
					"d+": this.getDate(), //日 
					"h+": this.getHours(), //小时 
					"m+": this.getMinutes(), //分 
					"s+": this.getSeconds(), //秒 
					"q+": Math.floor((this.getMonth() + 3) / 3), //季度 
					"S": this.getMilliseconds() //毫秒 
				};
				if(/(y+)/.test(fmt)) {
					fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
				}
				for(var k in o) {
					if(new RegExp("(" + k + ")").test(fmt)) {
						fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
					}
				}
				return fmt;
			}
			layui.use(['layer', 'laypage'], function() {
				var $ = layui.jquery;
				var layer = layui.layer;
				var laypage = layui.laypage;
				var list;
				var nowLen=0;
				function creatHtml(start, end) {
					var txt = "";
					for(var i = start; i < end; i++) {
						var processStatus = "";
						if(list[i].deleteReason == "同意申请") {
							processStatus = "已通过";
							proColor = "green";
						} else if(list[i].deleteReason == "用户撤销") {
							processStatus = "已撤销";
							proColor = "#FFB800";
						} else {
							processStatus = "被驳回";
							proColor = "red";
						}
						var startTime = new Date(list[i].startTime).format("yyyy-MM-dd hh:mm:ss");
						var endTime = new Date(list[i].endTime).format("yyyy-MM-dd hh:mm:ss");
						txt = txt + "<div class=\"layuiadmin-card-text\" style=\"background-color: gainsboro;margin-top:10px ;\">" +
							"<div class=\"layui-card-header\"><i class=\"layui-icon layui-icon-table\">" + list[i].processName + "</i>" +
							"<span style=\"position: absolute;right: 15px; color:" + proColor + "\">" + processStatus +
							"</span></div><div class=\"layui-card-body\"><p>" + "流程在途时间：" + startTime + "--" + endTime + "</p>" +
							"<p>流程结束说明：" + list[i].deleteReason + "</p>" +
							"<hr class=\"layui-bg-gray\" />" +
							"<button class=\"layui-btn layui-btn-lg layui-btn-radius layui-btn-primary\" pid=\"" + list[i].processInstanceId +
							"\">查看详情</button>" +
							"<button class=\"layui-btn layui-btn-lg layui-btn-radius layui-btn-primary\" pid=\"" + list[i].deploymentId +
							"\">查看流程</button></div></div>";
					}
					$("#queryProcessBox").html(txt);
					$("button").click(function() {
						if($(this).text() == "查看详情") {
							var processInstanceId = $(this).attr("pid");
							$.ajax({
								url: "/process/queryprocessdetail",
								type: "get",
								data: {
									"processInstanceId": processInstanceId
								},
								dataType: "json",
								success: function(data) {
									var txt = "<tr><td>流程名称</td><td>" + data.processName + "</td></tr>";
									txt = txt + "<tr><td>发起人</td><td>" + data.userName + "</td></tr>";
									var list = data.processSummary;
									for(var i = 0; i < list.length; i++) {
										txt = txt + "<tr><td>" + list[i].indexName + "</td><td>" + list[i].indexValue + "</td></tr>";
									}
									var startTime = new Date(data.startTime).format("yyyy-MM-dd hh:mm:ss");
									var endTime = new Date(data.endTime).format("yyyy-MM-dd hh:mm:ss");
									txt = txt + "<tr><td>发起时间</td><td>" + startTime + "</td></tr>";
									txt = txt + "<tr><td>结束时间</td><td>" + endTime + "</td></tr>";
									txt = txt + "<tr><td>结束说明</td><td>" + data.deleteReason + "</td></tr>";
									layer.open({
										type: 1,
										shadeClose: true,
										shade: 0.8,
										skin: 'layui-layer-rim', //加上边框
										area: ['90%', '80%'], //宽高
										content: '<fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;"><legend>流程详情</legend></fieldset>' +
											'<div class="layui-form"><table class="layui-table"><colgroup><col width="150"><col width="150"><col width="200">' +
											'<col></colgroup><thead><tr><th>属性名</th><th>属性值</th></tr></thead>' +
											'<tbody>' + txt + '</tbody></table></div>'
									});
								},
								error: function() {
									layer.msg('发生了未知错误！', {
										icon: 2
									});
								}
							});
						} else if($(this).text() == "查看流程") {
							var deploymentId = $(this).attr("pid");
							layer.open({
								type: 1,
								shadeClose: true,
								shade: 0.8,
								skin: 'layui-layer-rim', //加上边框
								area: ['90%', '80%'], //宽高
								content: '<img src="/process/downloadpng?deploymentId=' + deploymentId + '"/>'
							});
						} else {
							layer.msg('错误操作！', {
								icon: 2
							});
						}
					});
				};
				var userCode=$("#userCode",parent.document).attr("name");
				$(document).ready(function() {
					$.ajax({
						url: "/process/queryendprocess",
						type: "get",
						data: {
							"userCode": userCode,
							"page": 1,
							"num": 5
						},
						dataType: "json",
						success: function(data) {
							var len = data.result;
							if(len > 0) {
								list = data.queryResultList;
								nowLen=list.length;
								$("h2").hide();
								laypage.render({
									elem: 'demo6',
									count: len,
									limit: 5,
									layout: ['prev', 'page', 'next'],
									jump: function(obj, first) {
										if(!first) {
											$.ajax({
												url: "/process/queryendprocess",
												type: "get",
												data: {
													"userCode": "张三",
													"page": obj.curr,
													"num": 5
												},
												dataType: "json",
												success: function(data) {
													list = data.queryResultList;
													nowLen=list.length;
												},
												error: function() {
													layer.msg('发生了未知错误！', {
														icon: 2
													});
												}
											});
										}
										creatHtml(0, nowLen);
									}
								});
							} else {
								$("h2").text("您没有已结束的流程！");
							}
						},
						error: function() {
							$("h2").text("加载数据失败，请刷新试试！");
						}
					});
				});
			});
			//]]>
		</script>
	</body>

</html>