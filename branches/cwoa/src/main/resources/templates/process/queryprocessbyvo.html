<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>根据条件查询流程</title>
		<meta name="renderer" content="webkit" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link rel="stylesheet" href="../../static/css/reset.css" />
		<link rel="stylesheet" href="./../../static/layui/css/layui.css" />
	</head>

	<body>
		<fieldset class="layui-elem-field layui-field-title">
			<legend>查询流程</legend>
		</fieldset>
		<div class="layui-collapse" lay-accordion="">
			<div class="layui-colla-item">
				<h2 class="layui-colla-title">根据流程ID查询</h2>
				<div class="layui-colla-content layui-show">
					<form class="layui-form" action="">
						<div class="layui-form-item">
							<label class="layui-form-label">流程ID：</label>
							<div class="layui-input-block">
								<input type="text" placeholder="请输入流程ID..." class="layui-input" id="queryProId" />
							</div>
						</div>
						<div class="layui-form-item">
							<div class="layui-input-block">
								<button type="button" class="layui-btn layui-btn-lg  layui-btn-radius" id="byId">点击查询</button>
							</div>
						</div>
					</form>
				</div>
			</div>
			<div class="layui-colla-item">
				<h2 class="layui-colla-title">根据条件查询</h2>
				<div class="layui-colla-content">
					<form class="layui-form" action="">
						<div class="layui-form-item">
							<label class="layui-form-label">流程类型：</label>
							<div class="layui-input-block">
								<select name="modules" lay-verify="required" lay-search="" id="proType">
									<option value="">请选择或输入流程类型...必填</option>
									<option value="askforleave">请假申请</option>
									<option value="askforbusiness">出差申请</option>
									<option value="askforreimburse">报销申请</option>
								</select>
							</div>
						</div>
						<div class="layui-form-item">
							<label class="layui-form-label">发起人：</label>
							<div class="layui-input-block">
								<input type="text" placeholder="请输入流程发起人...可不填" class="layui-input" id="userName" />
							</div>
						</div>
						<div class="layui-form-item">
							<label class="layui-form-label">发起时间：</label>
							<div class="layui-input-block">
								<input type="text" placeholder="请选择流程发起时间...可不选" class="layui-input" id="startTime" />
							</div>
						</div>
						<div class="layui-form-item">
							<div class="layui-input-block">
								<button type="button" class="layui-btn layui-btn-lg  layui-btn-radius" id="byVo">点击查询</button>
							</div>
						</div>
					</form>
				</div>
			</div>
		</div>
		<h1 id="messageBox" style="display: none;">查询中ing...</h1>
		<div class="layui-fluid" style="margin-top: 10px;" id="queryProcessBox"></div>
		<script src="./../../static/layui/layui.js"></script>
		<script>
			//<![CDATA[
			Date.prototype.format = function(fmt) {
				var o = {
					"M+": this.getMonth() + 1, //月份 
					"d+": this.getDate(), //日 
					"h+": this.getHours(), //小时 
					"m+": this.getMinutes(), //分 
					"s+": this.getSeconds(), //秒 
					"q+": Math.floor((this.getMonth() + 3) / 3), //季度 
					"S": this.getMilliseconds() //毫秒 
				};
				if(/(y+)/.test(fmt)) {
					fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
				}
				for(var k in o) {
					if(new RegExp("(" + k + ")").test(fmt)) {
						fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
					}
				}
				return fmt;
			}
			layui.use(['layer', 'element', 'form', 'laydate'], function() {
				var $ = layui.jquery;
				var layer = layui.layer;
				var laydate = layui.laydate;
				var element = layui.element;
				var form = layui.form;
				laydate.render({
					elem: '#startTime',
					type: 'date'
				});
				var list = new Array();

				function creatHtml(start, end) {
					var txt = "";
					for(var i = start; i < end; i++) {
						var processStatus = "";
						if(list[i].deleteReason == "同意申请") {
							processStatus = "已通过";
							proColor = "green";
						} else if(list[i].deleteReason == "用户撤销") {
							processStatus = "已撤销";
							proColor = "#FFB800";
						} else if(list[i].deleteReason == "审批中") {
							processStatus = "审批中";
							proColor = "#1E9FFF";
						} else {
							processStatus = "被驳回";
							proColor = "red";
						}
						var startTime = new Date(list[i].startTime).format("yyyy-MM-dd hh:mm:ss");
						var testEndTime = list[i].endTime;
						if(testEndTime == null) {
							var endTime = "至今";
						} else {
							var endTime = new Date().format("yyyy-MM-dd hh:mm:ss");
						}
						var pro = list[i].processSummary;
						var summary = "";
						for(var j = 0; j < pro.length; j++) {
							summary = summary + "<p>" + pro[j].indexName + ":" + pro[j].indexValue + "</p>";
						}
						txt = txt + "<div class=\"layuiadmin-card-text\" style=\"background-color: gainsboro;margin-top:10px ;\"" +
							"\"><div class=\"layui-card-header\"><i class=\"layui-icon layui-icon-table\">" + list[i].processName + "</i>" +
							"<span style=\"position: absolute;right: 15px; color:" + proColor + "\">" + processStatus +
							"</span></div><div class=\"layui-card-body\"><h3>" + list[i].userDepartment + "-" + list[i].userName + "</h3>" +
							"<p>流程ID：" + list[i].processInstanceId + "</p>" +
							"<p>流程在途时间：" + startTime + "--" + endTime + "</p>" + summary +
							"<p>流程结束说明：" + list[i].deleteReason + "</p>" +
							"<hr class=\"layui-bg-gray\" />" +
							"<button class=\"layui-btn  layui-btn-radius layui-btn-primary\" cid=\"" + list[i].processInstanceId +
							"\">查看流程</button>" +
							"<button class=\"layui-btn  layui-btn-radius layui-btn-primary\" uid=\"" + list[i].fileName +
							"\">下载附件</button></div></div>";
					}
					$("#queryProcessBox").html(txt);
					$("button").click(function() {
						if($(this).text() == "查看流程") {
							var processInstanceId = $(this).attr("cid");
							layer.open({
								type: 1,
								shadeClose: true,
								shade: 0.8,
								skin: 'layui-layer-rim', //加上边框
								area: ['90%', '80%'], //宽高
								content: '<img src="/process/download?processInstanceId=' + processInstanceId + '"/>'
							});
						} else if($(this).text() == "下载附件") {
							var filename = $(this).attr("uid");
							if(!typeof(filename) == "undefined") {
								var url = '/file/down';
								var form = $("<form>"); //定义一个form表单
								form.attr("style", "display:none");
								form.attr("target", "");
								form.attr("method", "get"); //请求类型
								form.attr("action", url); //请求地址
								$("body").append(form); //将表单放置在web中
								var inputone = $("<input>");
								inputone.attr("type", "hidden");
								inputone.attr("name", "filename");
								inputone.attr("value", "文件名");
								form.append(inputone);
								var arr = str.split(',');
								for(var i = 0; i < arr.length; i++) {
									inputone.attr("value", arr[i]);
									form.submit(); //表单提交
								}
							} else {
								layer.msg('该申请没有附件！');
							}
						}
					});
				}
				$('#byId').click(function() {
					$("#queryProcessBox").html("");
					var queryProId = $('#queryProId').val();
					$.ajax({
						url: "/process/queryprocessdetail",
						type: "get",
						data: {
							"processInstanceId": queryProId
						},
						dataType: "json",
						success: function(result) {
							if(result.flag) {
								list.push(result);
								$('#messageBox').hide();
								creatHtml(0, 1);
							} else {
								$('#messageBox').text("没有找到符合条件的流程！");
								$('#messageBox').show();
							}
						},
						error: function() {
							$('#messageBox').text("网络错误！");
							$('#messageBox').show();
						}
					});
				});
				$('#byVo').click(function() {
					$("#queryProcessBox").html("");
					var processDefinitionKey = $('#proType option:selected').prop("value");
					var userQueryName = $('#userName').val();
					var dateTime = new Date($('#startTime').val()).getTime();
					if(isNaN(dateTime)) {
						dateTime = 0;
					}
					$.ajax({
						url: "/process/queryprocessbyvo",
						type: "get",
						data: {
							"processDefinitionKey": processDefinitionKey,
							"userName": userQueryName,
							"date": dateTime
						},
						dataType: "json",
						success: function(data) {
							if(data.result > 0) {
								list = data.queryResultList;
								$('#messageBox').hide();
								creatHtml(0, list.length);
							} else {
								$('#messageBox').text("没有找到符合条件的流程！");
								$('#messageBox').show();
							}
						},
						error: function() {
							$('#messageBox').text("网络错误！");
							$('#messageBox').show();
						}
					});
				});
			});
			//]]>
		</script>
	</body>

</html>