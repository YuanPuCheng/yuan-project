<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8" />
		<title>任务查询</title>
		<meta name="renderer" content="webkit" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link rel="stylesheet" href="../../static/css/reset.css" />
		<link rel="stylesheet" href="./../../static/layui/css/layui.css" />
		<style type="text/css">
			.layui-btn {
				margin-top: 5px;
			}
		</style>
	</head>

	<body layadmin-themealias="default">
		<h2>查询中ing...</h2>
		<div class="layui-fluid" style="margin-top: 10px;" id="queryProcessBox">
			<!-- 数据显示区域 -->
		</div>
		<center>
			<div id="demo6"></div>
		</center>
		<div class="layadmin-body-shade" layadmin-event="shade"></div>
		<script src="./../../static/layui/layui.js"></script>
		<script>
			//<![CDATA[
						Date.prototype.format = function(fmt) {
				var o = {
					"M+": this.getMonth() + 1, //月份 
					"d+": this.getDate(), //日 
					"h+": this.getHours(), //小时 
					"m+": this.getMinutes(), //分 
					"s+": this.getSeconds(), //秒 
					"q+": Math.floor((this.getMonth() + 3) / 3), //季度 
					"S": this.getMilliseconds() //毫秒 
				};
				if(/(y+)/.test(fmt)) {
					fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
				}
				for(var k in o) {
					if(new RegExp("(" + k + ")").test(fmt)) {
						fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
					}
				}
				return fmt;
			}
			layui.use(['layer', 'laypage'], function() {
				var $ = layui.jquery;
				var layer = layui.layer;
				var laypage = layui.laypage;
				var list;
				$(document).ready(function() {
					function creatHtml(start, end) {
						var txt = "";
						for(var i = start; i < end; i++) {
							var pro = list[i].processSummary;
							var summary = "";
							for(var j = 0; j < pro.length; j++) {
								summary = summary + "<p>" + pro[j].indexName + ":" + pro[j].indexValue + "</p>";
							}
							var startTimeFormat = new Date(list[i].startTime).format("yyyy-MM-dd hh:mm:ss");
							txt = txt + "<div class=\"layuiadmin-card-text\" style=\"background-color: gainsboro;margin-top:10px ;\" id=\"" + list[i].processInstanceId +
								"\"><div class=\"layui-card-header\"><i class=\"layui-icon layui-icon-table\">" + list[i].processName + "</i>" +
								"<i style=\"position: absolute;right: 15px;\">" + startTimeFormat +
								"</i></div><div class=\"layui-card-body\"><h3>" + list[i].userDepartment + "-" + list[i].userName + "</h3>" + summary +
								"<hr class=\"layui-bg-gray\" />" +
								"<button class=\"layui-btn  layui-btn-radius layui-btn-primary\" cid=\"" + list[i].processInstanceId +
								"\">查看流程</button>" +
								"<button class=\"layui-btn  layui-btn-radius layui-btn-primary\" tid=\"" + list[i].taskId + "\"" + "pid=\"" + list[i].processInstanceId +
								"\">同意申请</button><br />" +
								"<button class=\"layui-btn  layui-btn-radius layui-btn-primary\" uid=\"" + list[i].fileName +
								"\">下载附件</button>" +
								"<button class=\"layui-btn  layui-btn-radius layui-btn-primary\" pid=\"" + list[i].processInstanceId +
								"\">驳回申请</button></div></div>";
						}
						$("#queryProcessBox").html(txt);
						$("button").click(function() {
							if($(this).text() == "查看流程") {
								var processInstanceId = $(this).attr("cid");
								layer.open({
									type: 1,
									shadeClose: true,
									shade: 0.8,
									skin: 'layui-layer-rim', //加上边框
									area: ['90%', '80%'], //宽高
									content: '<img src="/process/download?processInstanceId=' + processInstanceId + '"/>'
								});
							} else if($(this).text() == "下载附件") {
								var fName = $(this).attr("uid");
								if(fName=='undefined') {
                                    layer.msg('该申请没有附件！');
								} else {
                                    $.ajax({
                                        url: "/file/queryfilenamebyid",
                                        type: "get",
                                        data: {
                                            "idArray": fName
                                        },
                                        dataType: "json",
                                        success: function(data) {
                                            var list=data;
                                            var txt="";
                                            for(var j = 0,len=list.length; j < len; j++) {
                                                txt = txt + "<tr><td>"+list[j].file_rename+
													"</td><td><a href='/file/down?filename="+list[j].file_name+"'>点击此处下载该附件</a></td></tr>";
                                            }
                                            layer.open({
                                                type: 1,
                                                shadeClose: true,
                                                shade: 0.8,
                                                skin: 'layui-layer-rim', //加上边框
                                                area: ['90%', '80%'], //宽高
                                                content: '<fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;"><legend>下载附件</legend></fieldset>' +
                                                '<div class="layui-form"><table class="layui-table"><colgroup><col width="150"><col width="150"><col width="200">' +
                                                '<col></colgroup><thead><tr><th>文件名</th><th>点击下载</th></tr></thead>' +
                                                '<tbody>' + txt + '</tbody></table></div>'
                                            });
                                        },
                                        error: function() {
                                            layer.msg('加载失败，请重试！', {
                                                icon: 2
                                            });
                                        }
                                    });
								}
							} else if($(this).text() == "同意申请") {
								var taskId = $(this).attr("tid");
								var processInstanceId = $(this).attr("pid");
								var click = false;
								layer.confirm('您确定批准该申请吗？', {
									btn: ['确定', '再想想'] //按钮
								}, function() {
									//确定触发的事件
									if(!click) {
										click = true;
										$.ajax({
											url: "/process/completetask",
											type: "get",
											data: {
												"taskId": taskId
											},
											dataType: "text", //预测服务端返回的数据类型
											success: function(data) { //请求成功的回调
												layer.msg('成功批准申请！', {
													icon: 1,
													btn: ['知道了']
												}, function() {
													//知道了触发的事件
													$("#" + processInstanceId).hide();
												});
											},
											error: function() { //请求失败的回调
												layer.msg('发生未知错误！', {
													icon: 2,
													btn: ['知道了']
												}, function() {
													//知道了触发的事件
													$("#" + processInstanceId).hide();
												});
											}
										});
									}
								}, function() {
									//再想想触发的事件
								});
							} else if($(this).text() == "驳回申请") {
								var processInstanceId = $(this).attr("pid");
								var click = false;
								layer.prompt({
									title: '请输入驳回理由',
									formType: 2
								}, function(text, index) {
									layer.close(index);
									//确定触发的事件
									if(!click) {
										click = true;
										$.ajax({
											url: "/process/deleteprocessinstance",
											type: "get",
											data: {
												"processInstanceId": processInstanceId,
												"reason": text
											},
											dataType: "text", //预测服务端返回的数据类型
											success: function(data) { //请求成功的回调
												layer.msg('成功驳回申请！', {
													icon: 1,
													btn: ['知道了']
												}, function() {
													//知道了触发的事件
													$("#" + processInstanceId).hide();
												});
											},
											error: function() { //请求失败的回调
												layer.msg('发生未知错误！', {
													icon: 2,
													btn: ['知道了']
												}, function() {
													//知道了触发的事件
													$("#" + processInstanceId).hide();
												});
											}
										});
									}
								});
							} else {
								layer.msg('错误操作！', {
									icon: 2
								});
							}
						});
					}
					var userCode=$("#userCode",parent.document).attr("name");
					if(typeof(userCode)=='undefined'){
					    userCode="Nancy";
					}
					$.ajax({
						url: "/process/querytask",
						type: "get",
						data: {
							"userCode": userCode
						},
						dataType: "json",
						success: function(data) {
							if(data.result) {
								$("h2").hide();
								list = data.queryResultList;
								var len = list.length;
								laypage.render({
									elem: 'demo6',
									count: len,
									limit: 5,
									layout: ['prev', 'page', 'next'],
									jump: function(obj, first) {
										var s = (obj.curr - 1) * 5;
										var e = s + 5;
										if(e > len) {
											e = len;
										}
										creatHtml(s, e);
									}
								});
							} else {
								$("h2").text("您没有待办的任务！");
							}
						},
						error: function() {
							$("h2").text("加载数据失败，请刷新试试！");
						}
					});
				});
			});
			//]]>
		</script>
	</body>

</html>